% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{article}
\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math} % this also loads fontspec
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else
  % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same}
\hypersetup{
  pdftitle={Fairness-aware},
  pdfauthor={Tianyi Xia},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}

\title{Fairness-aware}
\author{Tianyi Xia}
\date{2024-04-08}

\begin{document}
\maketitle

\hypertarget{r-markdown}{%
\subsection{R Markdown}\label{r-markdown}}

This is an R Markdown document. Markdown is a simple formatting syntax
for authoring HTML, PDF, and MS Word documents. For more details on
using R Markdown see \url{http://rmarkdown.rstudio.com}.

When you click the \textbf{Knit} button a document will be generated
that includes both content as well as the output of any embedded R code
chunks within the document. You can embed an R code chunk like this:

\begin{verbatim}
## Warning: 程辑包'caTools'是用R版本4.3.3 来建造的
\end{verbatim}

\begin{verbatim}
## Warning: 程辑包'neuralnet'是用R版本4.3.3 来建造的
\end{verbatim}

\begin{verbatim}
## Warning: 程辑包'DALEX'是用R版本4.3.3 来建造的
\end{verbatim}

\begin{verbatim}
## Welcome to DALEX (version: 2.4.3).
## Find examples and detailed introduction at: http://ema.drwhy.ai/
## Additional features will be available after installation of: ggpubr.
## Use 'install_dependencies()' to get all suggested dependencies
\end{verbatim}

\begin{verbatim}
## Warning: 程辑包'keras'是用R版本4.3.3 来建造的
\end{verbatim}

\begin{verbatim}
## Warning: 程辑包'tensorflow'是用R版本4.3.3 来建造的
\end{verbatim}

\begin{verbatim}
## Warning: 程辑包'VGAM'是用R版本4.3.3 来建造的
\end{verbatim}

\begin{verbatim}
## 载入需要的程辑包：stats4
\end{verbatim}

\begin{verbatim}
## 载入需要的程辑包：splines
\end{verbatim}

\begin{verbatim}
## Warning: 程辑包'tidyr'是用R版本4.3.2 来建造的
\end{verbatim}

\begin{verbatim}
## Warning: 程辑包'iml'是用R版本4.3.3 来建造的
\end{verbatim}

\begin{verbatim}
## Warning: 程辑包'dplyr'是用R版本4.3.2 来建造的
\end{verbatim}

\begin{verbatim}
## 
## 载入程辑包：'dplyr'
\end{verbatim}

\begin{verbatim}
## The following object is masked from 'package:DALEX':
## 
##     explain
\end{verbatim}

\begin{verbatim}
## The following object is masked from 'package:neuralnet':
## 
##     compute
\end{verbatim}

\begin{verbatim}
## The following objects are masked from 'package:stats':
## 
##     filter, lag
\end{verbatim}

\begin{verbatim}
## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union
\end{verbatim}

\begin{verbatim}
## Warning: 程辑包'randomForest'是用R版本4.3.3 来建造的
\end{verbatim}

\begin{verbatim}
## randomForest 4.7-1.1
\end{verbatim}

\begin{verbatim}
## Type rfNews() to see new features/changes/bug fixes.
\end{verbatim}

\begin{verbatim}
## 
## 载入程辑包：'randomForest'
\end{verbatim}

\begin{verbatim}
## The following object is masked from 'package:dplyr':
## 
##     combine
\end{verbatim}

\begin{verbatim}
## The following object is masked from 'package:ggplot2':
## 
##     margin
\end{verbatim}

\begin{verbatim}
## Warning: 程辑包'xgboost'是用R版本4.3.3 来建造的
\end{verbatim}

\begin{verbatim}
## 
## 载入程辑包：'xgboost'
\end{verbatim}

\begin{verbatim}
## The following object is masked from 'package:dplyr':
## 
##     slice
\end{verbatim}

\begin{verbatim}
## Warning: 程辑包'shapr'是用R版本4.3.3 来建造的
\end{verbatim}

\begin{verbatim}
## 
## 载入程辑包：'shapr'
\end{verbatim}

\begin{verbatim}
## The following object is masked from 'package:dplyr':
## 
##     explain
\end{verbatim}

\begin{verbatim}
## The following objects are masked from 'package:DALEX':
## 
##     explain, update_data
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{da}\OtherTok{=}\FunctionTok{read.csv}\NormalTok{(}\StringTok{\textquotesingle{}../data/compas{-}scores{-}two{-}years.csv\textquotesingle{}}\NormalTok{,}\AttributeTok{header=}\NormalTok{T)}
\NormalTok{da }\OtherTok{\textless{}{-}}\NormalTok{ da[ }\FunctionTok{grepl}\NormalTok{(}\StringTok{"Caucasian|African{-}American"}\NormalTok{, da}\SpecialCharTok{$}\NormalTok{race),]}
\NormalTok{da }\OtherTok{\textless{}{-}}\NormalTok{ da[,}\FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{,}\StringTok{\textquotesingle{}sex\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}age\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}c\_charge\_degree\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}priors\_count\textquotesingle{}}\NormalTok{,}\StringTok{"race"}\NormalTok{,}\StringTok{\textquotesingle{}end\textquotesingle{}}\NormalTok{,}\StringTok{"two\_year\_recid"}\NormalTok{)]}
\FunctionTok{names}\NormalTok{(da)[}\FunctionTok{names}\NormalTok{(da) }\SpecialCharTok{==} \StringTok{"c\_charge\_degree"}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"charge\_degree"}
\FunctionTok{names}\NormalTok{(da)[}\FunctionTok{names}\NormalTok{(da) }\SpecialCharTok{==} \StringTok{"end"}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"length\_of\_stay"}
\NormalTok{Y }\OtherTok{\textless{}{-}}\NormalTok{ da}\SpecialCharTok{$}\NormalTok{two\_year\_recid}
\NormalTok{da}\SpecialCharTok{$}\NormalTok{sex }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(da}\SpecialCharTok{$}\NormalTok{sex }\SpecialCharTok{==} \StringTok{"Male"}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{da}\SpecialCharTok{$}\NormalTok{charge\_degree }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(da}\SpecialCharTok{$}\NormalTok{charge\_degree }\SpecialCharTok{==} \StringTok{"M"}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{da}\SpecialCharTok{$}\NormalTok{race }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(da}\SpecialCharTok{$}\NormalTok{race }\SpecialCharTok{==} \StringTok{"Caucasian"}\NormalTok{,}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{07}\NormalTok{)}
\NormalTok{split }\OtherTok{\textless{}{-}} \FunctionTok{sample.split}\NormalTok{(Y, }\AttributeTok{SplitRatio =} \FloatTok{0.8}\NormalTok{)}

\NormalTok{train }\OtherTok{\textless{}{-}}\NormalTok{ da[split, ]   }
\NormalTok{test }\OtherTok{\textless{}{-}}\NormalTok{ da[}\SpecialCharTok{!}\NormalTok{split, ]}
\NormalTok{x\_train }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(da[split,}\FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}sex\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}age\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}charge\_degree\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}priors\_count\textquotesingle{}}\NormalTok{,}\StringTok{"race"}\NormalTok{,}\StringTok{\textquotesingle{}length\_of\_stay\textquotesingle{}}\NormalTok{)])  }\CommentTok{\# Features}
\NormalTok{y\_train }\OtherTok{\textless{}{-}}\NormalTok{ da[split,]}\SpecialCharTok{$}\NormalTok{two\_year\_recid}
\NormalTok{A\_train }\OtherTok{\textless{}{-}}\NormalTok{ da[split,]}\SpecialCharTok{$}\NormalTok{race  }\CommentTok{\# Binary sensitive feature}
\NormalTok{x\_test }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(da[}\SpecialCharTok{!}\NormalTok{split,}\FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}sex\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}age\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}charge\_degree\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}priors\_count\textquotesingle{}}\NormalTok{,}\StringTok{"race"}\NormalTok{,}\StringTok{\textquotesingle{}length\_of\_stay\textquotesingle{}}\NormalTok{)])  }\CommentTok{\# Features}
\NormalTok{y\_test }\OtherTok{\textless{}{-}}\NormalTok{ da[}\SpecialCharTok{!}\NormalTok{split,]}\SpecialCharTok{$}\NormalTok{two\_year\_recid}
\NormalTok{A\_test }\OtherTok{\textless{}{-}}\NormalTok{ da[}\SpecialCharTok{!}\NormalTok{split,]}\SpecialCharTok{$}\NormalTok{race}
\CommentTok{\# 查看结果}
\FunctionTok{cat}\NormalTok{(}\StringTok{"Training set dimensions:"}\NormalTok{, }\FunctionTok{dim}\NormalTok{(x\_train), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Training set dimensions: 4920 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{"Test set dimensions:"}\NormalTok{, }\FunctionTok{dim}\NormalTok{(x\_test), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Test set dimensions: 1230 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calibration }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(sensitive\_var, y\_pred, y\_true) \{}
\NormalTok{  protected\_points }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(sensitive\_var }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)}
\NormalTok{  y\_pred\_protected }\OtherTok{\textless{}{-}}\NormalTok{ y\_pred[protected\_points]}
\NormalTok{  y\_true\_protected }\OtherTok{\textless{}{-}}\NormalTok{ y\_true[protected\_points]}
\NormalTok{  p\_protected }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(y\_pred\_protected }\SpecialCharTok{==}\NormalTok{ y\_true\_protected) }\SpecialCharTok{/} \FunctionTok{length}\NormalTok{(y\_true\_protected)}
  
\NormalTok{  not\_protected\_points }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(sensitive\_var }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
\NormalTok{  y\_pred\_not\_protected }\OtherTok{\textless{}{-}}\NormalTok{ y\_pred[not\_protected\_points]}
\NormalTok{  y\_true\_not\_protected }\OtherTok{\textless{}{-}}\NormalTok{ y\_true[not\_protected\_points]}
\NormalTok{  p\_not\_protected }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(y\_pred\_not\_protected }\SpecialCharTok{==}\NormalTok{ y\_true\_not\_protected) }\SpecialCharTok{/} \FunctionTok{length}\NormalTok{(y\_true\_not\_protected)}
  
\NormalTok{  calibration\_value }\OtherTok{\textless{}{-}} \FunctionTok{abs}\NormalTok{(p\_protected }\SpecialCharTok{{-}}\NormalTok{ p\_not\_protected)}
  
  \FunctionTok{return}\NormalTok{(calibration\_value)}
\NormalTok{\}}
\NormalTok{accuracy\_race }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(sensitive\_var, y\_pred, y\_true) \{}
  \CommentTok{\# Find indices of the protected group}
\NormalTok{  protected\_points }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(sensitive\_var }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)}
\NormalTok{  y\_pred\_protected }\OtherTok{\textless{}{-}}\NormalTok{ y\_pred[protected\_points]}
\NormalTok{  y\_true\_protected }\OtherTok{\textless{}{-}}\NormalTok{ y\_true[protected\_points]}
  \CommentTok{\# Calculate accuracy for the protected group}
\NormalTok{  p\_protected }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(y\_pred\_protected }\SpecialCharTok{==}\NormalTok{ y\_true\_protected) }\SpecialCharTok{/} \FunctionTok{length}\NormalTok{(y\_true\_protected)}
  
  \CommentTok{\# Find indices of the not protected group}
\NormalTok{  not\_protected\_points }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(sensitive\_var }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
\NormalTok{  y\_pred\_not\_protected }\OtherTok{\textless{}{-}}\NormalTok{ y\_pred[not\_protected\_points]}
\NormalTok{  y\_true\_not\_protected }\OtherTok{\textless{}{-}}\NormalTok{ y\_true[not\_protected\_points]}
  \CommentTok{\# Calculate accuracy for the not protected group}
\NormalTok{  p\_not\_protected }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(y\_pred\_not\_protected }\SpecialCharTok{==}\NormalTok{ y\_true\_not\_protected) }\SpecialCharTok{/} \FunctionTok{length}\NormalTok{(y\_true\_not\_protected)}
  
  \CommentTok{\# Return both accuracies as a list}
  \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{protected =}\NormalTok{ p\_protected, }\AttributeTok{not\_protected =}\NormalTok{ p\_not\_protected))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Convert \textquotesingle{}two\_year\_recid\textquotesingle{} to a factor if it\textquotesingle{}s not already}
\NormalTok{da}\SpecialCharTok{$}\NormalTok{two\_year\_recid }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(da}\SpecialCharTok{$}\NormalTok{two\_year\_recid)}

\CommentTok{\# Train the Random Forest model as a classifier}
\NormalTok{model }\OtherTok{\textless{}{-}} \FunctionTok{randomForest}\NormalTok{(two\_year\_recid }\SpecialCharTok{\textasciitilde{}}\NormalTok{ sex }\SpecialCharTok{+}\NormalTok{ age }\SpecialCharTok{+}\NormalTok{ charge\_degree }\SpecialCharTok{+}\NormalTok{ priors\_count }\SpecialCharTok{+}\NormalTok{ race }\SpecialCharTok{+}\NormalTok{ length\_of\_stay, }
                      \AttributeTok{data =}\NormalTok{ da, }
                      \AttributeTok{ntree =} \DecValTok{100}\NormalTok{)}
\NormalTok{y\_pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(model, x\_test)}
\NormalTok{accuracy }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(y\_pred }\SpecialCharTok{==}\NormalTok{ y\_test)}
\FunctionTok{print}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Accuracy:"}\NormalTok{, accuracy))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Accuracy: 0.926016260162602"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print}\NormalTok{(}\FunctionTok{accuracy\_race}\NormalTok{(x\_test[,}\StringTok{\textquotesingle{}race\textquotesingle{}}\NormalTok{],y\_pred,y\_test))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $protected
## [1] 0.9295213
## 
## $not_protected
## [1] 0.9205021
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Calibration:"}\NormalTok{, }\FunctionTok{calibration}\NormalTok{(x\_test[,}\StringTok{\textquotesingle{}race\textquotesingle{}}\NormalTok{],y\_pred,y\_test)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Calibration: 0.00901918454553552"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{results\_rf }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \StringTok{\textasciigrave{}}\AttributeTok{Random Forest}\StringTok{\textasciigrave{}} \OtherTok{=} \FunctionTok{c}\NormalTok{(accuracy, }\FunctionTok{accuracy\_race}\NormalTok{(x\_test[,}\StringTok{\textquotesingle{}race\textquotesingle{}}\NormalTok{],y\_pred,y\_test)}\SpecialCharTok{$}\NormalTok{protected, }\FunctionTok{accuracy\_race}\NormalTok{(x\_test[,}\StringTok{\textquotesingle{}race\textquotesingle{}}\NormalTok{],y\_pred,y\_test)}\SpecialCharTok{$}\NormalTok{not\_protected, }\FunctionTok{calibration}\NormalTok{(x\_test[,}\StringTok{\textquotesingle{}race\textquotesingle{}}\NormalTok{],y\_pred,y\_test)),}
  \AttributeTok{row.names =} \FunctionTok{c}\NormalTok{(}\StringTok{"Model Accuracy"}\NormalTok{, }\StringTok{"Protected"}\NormalTok{, }\StringTok{"Not Protected"}\NormalTok{, }\StringTok{"Calibration"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model }\OtherTok{\textless{}{-}} \FunctionTok{xgboost}\NormalTok{(}\AttributeTok{data =}\NormalTok{ x\_train, }\AttributeTok{label =}\NormalTok{ y\_train, }\AttributeTok{nround =} \DecValTok{20}\NormalTok{, }\AttributeTok{verbose =} \ConstantTok{FALSE}\NormalTok{)}

\NormalTok{explainer }\OtherTok{\textless{}{-}} \FunctionTok{shapr}\NormalTok{(x\_train, model)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## The specified model provides feature classes that are NA. The classes of data are taken as the truth.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(y\_train)}
\NormalTok{explanation }\OtherTok{\textless{}{-}} \FunctionTok{explain}\NormalTok{( x\_test,}
                        \AttributeTok{approach =} \StringTok{"empirical"}\NormalTok{,}
                        \AttributeTok{explainer =}\NormalTok{ explainer,}
                        \AttributeTok{prediction\_zero =}\NormalTok{ p)}

\FunctionTok{print}\NormalTok{(explanation}\SpecialCharTok{$}\NormalTok{dt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            none          sex           age charge_degree priors_count
##    1: 0.4662602  0.013265721  0.0004083264   0.007324682  -0.11267897
##    2: 0.4662602  0.013164470  0.0343570813   0.014292850  -0.06231050
##    3: 0.4662601 -0.034374004 -0.0236521219  -0.033754027  -0.05991526
##    4: 0.4662602  0.011128832  0.0351585683   0.018770506  -0.07377799
##    5: 0.4662601  0.010681863 -0.0395533094   0.017015992  -0.07762538
##   ---                                                                
## 1226: 0.4662601  0.004434993 -0.1050729728   0.013895747  -0.02693263
## 1227: 0.4662602  0.012199113  0.0177911272   0.015949975  -0.06595766
## 1228: 0.4662602  0.006883470  0.0115652158  -0.009211248  -0.02160611
## 1229: 0.4662602  0.012761079  0.0342215346   0.018005475  -0.07023390
## 1230: 0.4662602  0.014025732  0.0339713956   0.015627717  -0.08159046
##              race length_of_stay
##    1:  0.02475243      0.4363923
##    2:  0.02141949     -0.4899228
##    3: -0.01929222     -0.2901120
##    4: -0.02051219     -0.4291922
##    5:  0.02286888     -0.3930537
##   ---                           
## 1226: -0.02653896     -0.3311264
## 1227:  0.01879926     -0.4593748
## 1228:  0.01114031      0.1157586
## 1229: -0.02649632     -0.4405813
## 1230:  0.02430835     -0.4730566
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{explanation}\SpecialCharTok{$}\NormalTok{dt }\OtherTok{\textless{}{-}}\NormalTok{ explanation}\SpecialCharTok{$}\NormalTok{dt }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{rename}\NormalTok{(}\AttributeTok{model =}\NormalTok{ none) }\SpecialCharTok{\%\textgreater{}\%}  
  \FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{race)}
\CommentTok{\#plot(explanation)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sharply\_mean}\OtherTok{=}\FunctionTok{colMeans}\NormalTok{(explanation}\SpecialCharTok{$}\NormalTok{dt)}
\NormalTok{y\_pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(model, x\_test)}
\NormalTok{y\_labels }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(y\_pred }\SpecialCharTok{\textgreater{}=} \FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{accuracy }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(y\_labels }\SpecialCharTok{==}\NormalTok{ y\_test)}
         

\NormalTok{data\_long }\OtherTok{\textless{}{-}} \FunctionTok{pivot\_longer}\NormalTok{(explanation}\SpecialCharTok{$}\NormalTok{dt, }\AttributeTok{cols =} \FunctionTok{everything}\NormalTok{(), }\AttributeTok{names\_to =} \StringTok{"Feature"}\NormalTok{, }\AttributeTok{values\_to =} \StringTok{"ShapleyValue"}\NormalTok{)}
\NormalTok{data\_long}\SpecialCharTok{$}\NormalTok{Feature }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(data\_long}\SpecialCharTok{$}\NormalTok{Feature, }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"model"}\NormalTok{, }\FunctionTok{setdiff}\NormalTok{(data\_long}\SpecialCharTok{$}\NormalTok{Feature, }\StringTok{"model"}\NormalTok{)))}
\FunctionTok{ggplot}\NormalTok{(data\_long, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Feature, }\AttributeTok{y =}\NormalTok{ ShapleyValue)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{45}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Boxplot of Shapley Values for Each Feature"}\NormalTok{, }\AttributeTok{x =} \StringTok{"Feature"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Shapley Value"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{Fairness-aware_files/figure-latex/unnamed-chunk-4-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Accuracy:"}\NormalTok{, accuracy))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Accuracy: 0.884552845528455"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print}\NormalTok{(}\FunctionTok{accuracy\_race}\NormalTok{(x\_test[,}\StringTok{\textquotesingle{}race\textquotesingle{}}\NormalTok{],y\_labels,y\_test))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $protected
## [1] 0.900266
## 
## $not_protected
## [1] 0.8598326
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Calibration:"}\NormalTok{, }\FunctionTok{calibration}\NormalTok{(x\_test[,}\StringTok{\textquotesingle{}race\textquotesingle{}}\NormalTok{],y\_labels,y\_test)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Calibration: 0.0404333214635448"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{results\_xg }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \StringTok{\textasciigrave{}}\AttributeTok{XGBoost}\StringTok{\textasciigrave{}} \OtherTok{=} \FunctionTok{c}\NormalTok{(accuracy, }\FunctionTok{accuracy\_race}\NormalTok{(x\_test[,}\StringTok{\textquotesingle{}race\textquotesingle{}}\NormalTok{],y\_labels,y\_test)}\SpecialCharTok{$}\NormalTok{protected, }\FunctionTok{accuracy\_race}\NormalTok{(x\_test[,}\StringTok{\textquotesingle{}race\textquotesingle{}}\NormalTok{],y\_labels,y\_test)}\SpecialCharTok{$}\NormalTok{not\_protected, }\FunctionTok{calibration}\NormalTok{(x\_test[,}\StringTok{\textquotesingle{}race\textquotesingle{}}\NormalTok{],y\_labels,y\_test)),}
  \AttributeTok{row.names =} \FunctionTok{c}\NormalTok{(}\StringTok{"Model Accuracy"}\NormalTok{, }\StringTok{"Protected"}\NormalTok{, }\StringTok{"Not Protected"}\NormalTok{, }\StringTok{"Calibration"}\NormalTok{)}
\NormalTok{)}
\FunctionTok{print}\NormalTok{(sharply\_mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          model            sex            age  charge_degree   priors_count 
##   4.662602e-01  -1.585255e-03  -3.031974e-05  -7.416862e-04  -1.945618e-03 
## length_of_stay 
##   7.487567e-03
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{result\_df }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(results\_rf, results\_xg)}
\FunctionTok{print}\NormalTok{(result\_df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                Random.Forest    XGBoost
## Model Accuracy   0.926016260 0.88455285
## Protected        0.929521277 0.90026596
## Not Protected    0.920502092 0.85983264
## Calibration      0.009019185 0.04043332
\end{verbatim}

Note that the \texttt{echo\ =\ FALSE} parameter was added to the code
chunk to prevent printing of the R code that generated the plot.

\end{document}
